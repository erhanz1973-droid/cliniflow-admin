<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cliniflow Admin V2 â€“ Treatments</title>
  <style>
    :root { --bg:#f6f7f9; --card:#fff; --b:#e5e7eb; --p:#2563eb; --g:#16a34a; --r:#dc2626; }
    body{ font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif; margin:0; background:var(--bg); color:#111827; }
    .wrap{ max-width:980px; margin:0 auto; padding:12px; }
    h1{ font-size:18px; margin:8px 0 12px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .card{ background:var(--card); border:1px solid var(--b); border-radius:10px; padding:12px; box-shadow:0 1px 2px rgba(0,0,0,.04); }
    label{ font-size:12px; color:#374151; display:block; margin-bottom:6px; }
    input, select, button{
      font-size:16px; padding:10px 12px; border-radius:10px; border:1px solid var(--b); background:#fff;
    }
    button{ cursor:pointer; border:none; background:var(--p); color:#fff; font-weight:700; }
    button.secondary{ background:#111827; }
    button.ghost{ background:#fff; color:#111827; border:1px solid var(--b); }
    button.danger{ background:var(--r); }
    .pill{ display:inline-flex; padding:6px 10px; border-radius:999px; background:#eef2ff; color:#3730a3; font-weight:700; font-size:12px; }
    .muted{ color:#6b7280; font-size:12px; }
    .gridWrap{ overflow-x:auto; -webkit-overflow-scrolling:touch; padding-bottom:6px; }
    .grid{
      display:grid;
      grid-template-columns: repeat(8, minmax(44px, 1fr));
      gap:8px;
      min-width: 420px;
    }
    .tooth{
      user-select:none;
      text-align:center;
      padding:12px 0;
      border-radius:12px;
      border:2px solid var(--b);
      background:#fff;
      font-weight:800;
      cursor:pointer;
    }
    .tooth.active{ border-color:var(--p); background:#dbeafe; }
    .tooth.has{ border-color:var(--g); background:#bbf7d0; }
    .tooth.badge::after{
      content: attr(data-count);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      margin-left:6px;
      min-width:18px;
      height:18px;
      padding:0 6px;
      border-radius:999px;
      background:#111827;
      color:#fff;
      font-size:12px;
      font-weight:800;
    }
    .two{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width: 840px){ .two{ grid-template-columns: 1fr; } }
    .list{ margin-top:10px; display:flex; flex-direction:column; gap:8px; }
    .item{ border:1px solid var(--b); border-radius:12px; padding:10px; display:flex; justify-content:space-between; gap:10px; align-items:center; background:#fff; }
    .item b{ font-size:14px; }
    .item small{ display:block; color:#6b7280; }
    .status{ font-weight:800; font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--b); }
    .ok{ background:#dcfce7; border-color:#86efac; }
    .planned{ background:#dbeafe; border-color:#93c5fd; }
    .warn{ background:#fee2e2; border-color:#fecaca; }
    .hr{ height:1px; background:var(--b); margin:10px 0; }
    .err{ color:var(--r); font-weight:700; }
    .okmsg{ color:var(--g); font-weight:700; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ðŸ¦· Cliniflow Admin V2 â€“ Treatments</h1>

    <div class="card" style="margin-bottom:12px;">
      <div class="row">
        <div style="flex:1; min-width:300px;">
          <label>Admin Token</label>
          <input id="adminToken" type="text" placeholder="Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." style="width:100%" />
          <div class="muted">Admin token localStorage'dan otomatik yÃ¼klenir.</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div style="flex:1; min-width:260px;">
          <label>Hasta seÃ§ (serverâ€™dan tokens listesi)</label>
          <select id="selPatient" style="width:100%"></select>
          <div class="muted" id="patientMeta">â€”</div>
        </div>

        <div style="min-width:210px;">
          <label>Hasta Token (otomatik dolar)</label>
          <input id="patientToken" placeholder="t_xxx" style="width:100%" />
          <div class="muted">Bu token header olarak gÃ¶nderilir: <b>x-patient-token</b></div>
        </div>

        <div class="row" style="gap:8px;">
          <button onclick="refreshTokens()">Listeyi Yenile</button>
          <button class="secondary" onclick="loadTreatments()">Treatments YÃ¼kle</button>
        </div>
      </div>

      <div class="hr"></div>
      <div class="muted">
        Not: Kaydetme iÃ§in serverâ€™da <b>POST /api/patient/:patientId/treatments</b> routeâ€™u olmalÄ±. (AÅŸaÄŸÄ±da patchâ€™i verdim.)
      </div>
      <div id="msg" class="muted" style="margin-top:8px;"></div>
    </div>

    <div class="two" style="margin-top:12px;">
      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <b>Ãœst Ã‡ene</b>
          <span class="pill">FDI 11â€“18 / 21â€“28</span>
        </div>
        <div class="gridWrap" style="margin-top:10px;">
          <div class="grid" id="upperRow1"></div>
          <div style="height:8px;"></div>
          <div class="grid" id="upperRow2"></div>
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <b>Alt Ã‡ene</b>
          <span class="pill">FDI 31â€“38 / 41â€“48</span>
        </div>
        <div class="gridWrap" style="margin-top:10px;">
          <div class="grid" id="lowerRow1"></div>
          <div style="height:8px;"></div>
          <div class="grid" id="lowerRow2"></div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <div class="row" style="justify-content:space-between;">
        <div>
          <b>SeÃ§ili DiÅŸ: </b><span id="selTooth" class="pill">â€”</span>
          <div class="muted" id="selToothHint">DiÅŸe tÄ±kla, iÅŸlem ekle.</div>
        </div>
        <button class="ghost" onclick="clearSelection()">SeÃ§imi Temizle</button>
      </div>

      <div class="hr"></div>

      <div class="row">
        <div style="flex:1; min-width:220px;">
          <label>Ä°ÅŸlem TÃ¼rÃ¼</label>
          <select id="procType" style="width:100%">
            <option value="IMPLANT">Implant</option>
            <option value="CROWN">Crown</option>
            <option value="FILLING">Filling</option>
            <option value="ROOT_CANAL">Root Canal</option>
            <option value="EXTRACTION">Extraction</option>
          </select>
        </div>

        <div style="min-width:220px;">
          <label>Status</label>
          <select id="procStatus" style="width:100%">
            <option value="PLANNED">PLANNED</option>
            <option value="DONE">DONE</option>
          </select>
        </div>

        <div style="min-width:220px;">
          <label>Tarih</label>
          <input id="procDate" type="date" style="width:100%"/>
        </div>

        <div style="min-width:160px;">
          <label>&nbsp;</label>
          <button style="width:100%" onclick="addProcedure()">+ Ekle & Kaydet</button>
        </div>
      </div>

      <div class="hr"></div>

      <b>Bu diÅŸteki iÅŸlemler</b>
      <div class="muted">Åžimdilik sadece listeleme + ekleme var.</div>
      <div class="list" id="procList"></div>
    </div>
  </div>

<script>
  const API = location.origin;

  const U1 = ["11","12","13","14","15","16","17","18"];
  const U2 = ["21","22","23","24","25","26","27","28"];
  const L1 = ["31","32","33","34","35","36","37","38"];
  const L2 = ["41","42","43","44","45","46","47","48"];

  let SELECTED_TOOTH = null;
  let DATA = { patientId:"", teeth:[] };

  const elMsg = document.getElementById("msg");
  const elSelPatient = document.getElementById("selPatient");
  const elToken = document.getElementById("patientToken");
  const elPatientMeta = document.getElementById("patientMeta");
  const elSelTooth = document.getElementById("selTooth");
  const elProcList = document.getElementById("procList");

  function setMsg(text, kind="muted"){
    elMsg.className = kind === "ok" ? "okmsg" : (kind==="err" ? "err" : "muted");
    elMsg.textContent = text || "";
  }

  function toothKey(id){ return String(id||"").trim(); }

  function findTooth(toothId){
    toothId = toothKey(toothId);
    return (DATA.teeth || []).find(t => toothKey(t.toothId) === toothId);
  }

  function ensureTooth(toothId){
    toothId = toothKey(toothId);
    let t = findTooth(toothId);
    if (!t){
      // jaw bilgisi opsiyonel; server tarafÄ±nda da zorunlu deÄŸil
      DATA.teeth = DATA.teeth || [];
      DATA.teeth.push({ toothId, procedures: [] });
      t = findTooth(toothId);
    }
    t.procedures = t.procedures || [];
    return t;
  }

  function renderRow(elId, arr){
    const el = document.getElementById(elId);
    el.innerHTML = "";
    arr.forEach(id => {
      const d = document.createElement("div");
      d.className = "tooth";
      d.textContent = id;
      d.onclick = () => selectTooth(id);
      el.appendChild(d);
    });
  }

  function refreshBadgeAndColors(){
    const all = document.querySelectorAll(".tooth");
    all.forEach(el => {
      const id = toothKey(el.textContent);
      const t = findTooth(id);
      const count = (t?.procedures || []).length;

      el.classList.remove("has","badge","active");
      el.removeAttribute("data-count");

      if (count > 0){
        el.classList.add("has","badge");
        el.setAttribute("data-count", String(count));
      }
      if (SELECTED_TOOTH && id === SELECTED_TOOTH){
        el.classList.add("active");
      }
    });
  }

  function selectTooth(id){
    SELECTED_TOOTH = toothKey(id);
    elSelTooth.textContent = SELECTED_TOOTH;
    renderSelectedToothList();
    refreshBadgeAndColors();
  }

  function clearSelection(){
    SELECTED_TOOTH = null;
    elSelTooth.textContent = "â€”";
    elProcList.innerHTML = "";
    refreshBadgeAndColors();
  }

  function fmtDate(ts){
    if (!ts) return "â€”";
    const d = new Date(ts);
    if (isNaN(d.getTime())) return "â€”";
    return d.toISOString().slice(0,10);
  }

  function renderSelectedToothList(){
    elProcList.innerHTML = "";
    if (!SELECTED_TOOTH) return;

    const t = ensureTooth(SELECTED_TOOTH);
    const procs = t.procedures || [];
    if (procs.length === 0){
      const div = document.createElement("div");
      div.className = "muted";
      div.textContent = "Bu diÅŸte henÃ¼z iÅŸlem yok.";
      elProcList.appendChild(div);
      return;
    }

    procs
      .slice()
      .sort((a,b)=>(b.createdAt||0)-(a.createdAt||0))
      .forEach(p => {
        const row = document.createElement("div");
        row.className = "item";
        const left = document.createElement("div");
        const st = String(p.status||"PLANNED").toUpperCase();
        const stClass = st === "DONE" ? "status ok" : "status planned";
        left.innerHTML = `<b>${p.type || "PROC"}</b>
          <small>Tarih: ${fmtDate(p.scheduledAt)} â€¢ OluÅŸ: ${fmtDate(p.createdAt)}</small>`;

        const right = document.createElement("div");
        const badge = document.createElement("span");
        badge.className = stClass;
        badge.textContent = st;
        right.appendChild(badge);

        row.appendChild(left);
        row.appendChild(right);
        elProcList.appendChild(row);
      });
  }

  function getAdminToken(){
    // Ã–nce input alanÄ±ndan al
    const elAdminToken = document.getElementById('adminToken');
    if (elAdminToken && elAdminToken.value && elAdminToken.value.trim()) {
      return elAdminToken.value.trim();
    }
    // Input boÅŸsa localStorage'dan al
    const savedToken = localStorage.getItem('admin_token');
    if (savedToken && savedToken.trim()) {
      // EÄŸer input varsa ama boÅŸsa, localStorage'dan yÃ¼kle
      if (elAdminToken && !elAdminToken.value) {
        elAdminToken.value = savedToken;
      }
      return savedToken.trim();
    }
    return '';
  }

  async function refreshTokens(){
    const adminToken = getAdminToken();
    if (!adminToken) {
      setMsg("âš ï¸ Admin token bulunamadÄ±. LÃ¼tfen yukarÄ±daki Admin Token alanÄ±na token'Ä± girin.", "err");
      // Input alanÄ±na odaklan
      const elAdminToken = document.getElementById('adminToken');
      if (elAdminToken) {
        elAdminToken.focus();
      }
      return;
    }

    try{
      setMsg("Tokens listesi Ã§ekiliyor...");
      const headers = {
        "Content-Type": "application/json"
      };
      
      if (adminToken.startsWith("Bearer ")) {
        headers["Authorization"] = adminToken;
      } else {
        headers["Authorization"] = `Bearer ${adminToken}`;
      }

      const r = await fetch(`${API}/api/admin/tokens`, {
        headers: headers
      });
      
      if (r.status === 401) {
        setMsg("âŒ Admin token geÃ§ersiz veya sÃ¼resi dolmuÅŸ. LÃ¼tfen admin token girin.", "err");
        return;
      }

      const j = await r.json();
      if (!j?.ok) throw new Error("tokens_failed");

      const items = (j.items || []).slice().sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
      elSelPatient.innerHTML = "";

      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "â€” Hasta seÃ§ â€”";
      elSelPatient.appendChild(opt0);

      items.forEach(it=>{
        const opt = document.createElement("option");
        opt.value = it.patientId || "";
        opt.dataset.token = it.token || "";
        opt.dataset.name = it.name || "";
        opt.dataset.phone = it.phone || "";
        opt.textContent = `${it.patientId} â€¢ ${it.name || "â€”"} â€¢ ${it.phone || "â€”"} â€¢ ${it.role || "â€”"}`;
        elSelPatient.appendChild(opt);
      });

      setMsg("HazÄ±r. Hasta seÃ§ip 'Treatments YÃ¼kle' de.", "ok");
    }catch(e){
      setMsg("Tokens listesi alÄ±namadÄ±. /api/admin/tokens Ã§alÄ±ÅŸÄ±yor mu?", "err");
    }
  }

  elSelPatient.addEventListener("change", ()=>{
    const opt = elSelPatient.selectedOptions?.[0];
    const pid = opt?.value || "";
    const tok = opt?.dataset?.token || "";
    const nm = opt?.dataset?.name || "";
    const ph = opt?.dataset?.phone || "";

    if (tok) elToken.value = tok;
    elPatientMeta.textContent = pid ? `SeÃ§ili: ${pid} â€¢ ${nm} â€¢ ${ph}` : "â€”";
    clearSelection();
  });

  function authHeaders(){
    const tok = String(elToken.value || "").trim();
    const h = { "Content-Type":"application/json" };
    if (tok) h["x-patient-token"] = tok;
    return h;
  }

  async function loadTreatments(){
    const pid = String(elSelPatient.value || "").trim();
    if (!pid) return setMsg("Ã–nce hasta seÃ§.", "err");

    try{
      setMsg("Treatments yÃ¼kleniyor...");
      const r = await fetch(`${API}/api/patient/${encodeURIComponent(pid)}/treatments`, {
        headers: authHeaders()
      });
      const j = await r.json().catch(()=>null);

      if (!r.ok){
        const err = j?.error || `${r.status}`;
        setMsg(`YÃ¼klenemedi: ${err} (Token/Approve kontrol et)`, "err");
        return;
      }

      DATA = j || { patientId: pid, teeth: [] };
      if (!Array.isArray(DATA.teeth)) DATA.teeth = [];
      setMsg("YÃ¼klendi.", "ok");
      clearSelection();
      refreshBadgeAndColors();
    }catch(e){
      setMsg("YÃ¼kleme hatasÄ±. Server eriÅŸimi var mÄ±?", "err");
    }
  }

  async function addProcedure(){
    const pid = String(elSelPatient.value || "").trim();
    if (!pid) return setMsg("Ã–nce hasta seÃ§.", "err");
    if (!SELECTED_TOOTH) return setMsg("Ã–nce diÅŸ seÃ§.", "err");

    const type = document.getElementById("procType").value;
    const status = document.getElementById("procStatus").value;
    const date = document.getElementById("procDate").value;
    if (!date) return setMsg("Tarih seÃ§.", "err");

    // UI optimistik: Ã¶nce localâ€™e ekle, sonra serverâ€™a yaz
    const t = ensureTooth(SELECTED_TOOTH);
    const createdAt = Date.now();
    const scheduledAt = new Date(date + "T00:00:00").getTime();

    const payload = {
      toothId: SELECTED_TOOTH,
      procedure: { type, status, createdAt, scheduledAt }
    };

    try{
      setMsg("Kaydediliyor...");
      const r = await fetch(`${API}/api/patient/${encodeURIComponent(pid)}/treatments`, {
        method: "POST",
        headers: authHeaders(),
        body: JSON.stringify(payload)
      });

      const j = await r.json().catch(()=>null);

      if (!r.ok){
        const err = j?.error || `${r.status}`;
        setMsg(`Kaydetme baÅŸarÄ±sÄ±z: ${err} (POST route var mÄ±?)`, "err");
        return;
      }

      // Server son halini dÃ¶ndÃ¼rÃ¼rse onu al; dÃ¶ndÃ¼rmezse yeniden yÃ¼kle
      if (j?.teeth) {
        DATA = j;
      } else {
        await loadTreatments();
      }

      setMsg("Kaydedildi âœ…", "ok");
      renderSelectedToothList();
      refreshBadgeAndColors();
    }catch(e){
      setMsg("Kaydetme hatasÄ±. Server POST route yoksa bu olur.", "err");
    }
  }

  // Admin token yÃ¼kleme ve kaydetme
  function initAdminToken() {
    const elAdminToken = document.getElementById('adminToken');
    if (!elAdminToken) return false;
    
    // Event listener'larÄ± ekle (sadece bir kez)
    if (!elAdminToken.hasAttribute('data-listeners-added')) {
      elAdminToken.setAttribute('data-listeners-added', 'true');
      
      // Token deÄŸiÅŸtiÄŸinde localStorage'a kaydet
      elAdminToken.addEventListener('change', (e) => {
        const token = e.target.value.trim();
        if (token) {
          localStorage.setItem('admin_token', token);
          refreshTokens();
        } else {
          localStorage.removeItem('admin_token');
        }
      });
      
      // Input alanÄ±na yazÄ±ldÄ±ÄŸÄ±nda da kaydet
      elAdminToken.addEventListener('blur', (e) => {
        const token = e.target.value.trim();
        if (token) {
          localStorage.setItem('admin_token', token);
          refreshTokens();
        } else {
          localStorage.removeItem('admin_token');
        }
      });
      
      // Input alanÄ±na her yazÄ±ldÄ±ÄŸÄ±nda da kaydet (real-time kaydetme)
      let inputTimeout;
      elAdminToken.addEventListener('input', (e) => {
        const token = e.target.value.trim();
        if (token) {
          localStorage.setItem('admin_token', token);
          clearTimeout(inputTimeout);
          inputTimeout = setTimeout(() => {
            if (token) refreshTokens();
          }, 500);
        }
      });
    }
    
    // localStorage'dan token'Ä± yÃ¼kle
    const savedToken = localStorage.getItem('admin_token');
    if (savedToken && savedToken.trim()) {
      elAdminToken.value = savedToken;
      return true;
    }
    return false;
  }

  // init - DiÅŸ gridlerini render et
  renderRow("upperRow1", U1);
  renderRow("upperRow2", U2);
  renderRow("lowerRow1", L1);
  renderRow("lowerRow2", L2);
  
  // Token'Ä± otomatik yÃ¼kle - DOM hazÄ±r olana kadar bekle
  function loadTokenWhenReady() {
    const elAdminToken = document.getElementById('adminToken');
    if (!elAdminToken) {
      // DOM henÃ¼z hazÄ±r deÄŸilse tekrar dene
      setTimeout(loadTokenWhenReady, 100);
      return;
    }
    
    // localStorage'dan token kontrolÃ¼
    const savedToken = localStorage.getItem('admin_token');
    console.log('[Admin Token] localStorage token:', savedToken ? 'Bulundu' : 'BulunamadÄ±');
    
    // Token'Ä± yÃ¼kle
    const tokenLoaded = initAdminToken();
    console.log('[Admin Token] Token yÃ¼klendi:', tokenLoaded);
    console.log('[Admin Token] Input deÄŸeri:', elAdminToken.value);
    
    // Token yÃ¼klendiyse listeyi otomatik yenile
    if (tokenLoaded) {
      console.log('[Admin Token] Liste yenileniyor...');
      setTimeout(() => refreshTokens(), 300);
    } else {
      console.log('[Admin Token] Token yÃ¼klenmedi, liste yenilenmeyecek');
    }
  }
  
  // DOM hazÄ±r olduÄŸunda token'Ä± yÃ¼kle
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadTokenWhenReady);
  } else {
    // DOM zaten hazÄ±rsa hemen yÃ¼kle
    loadTokenWhenReady();
  }
  
  // Sayfa tamamen yÃ¼klendiÄŸinde de bir kez daha kontrol et (garanti)
  window.addEventListener('load', function() {
    const tokenLoaded = initAdminToken();
    if (tokenLoaded) {
      setTimeout(() => refreshTokens(), 100);
    }
  });
</script>
</body>
</html>
